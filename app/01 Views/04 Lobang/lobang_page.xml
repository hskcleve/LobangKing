<Page id="lobang_page" loaded="onLoaded" navigatedTo="onNavigatedTo"
    xmlns:lv="nativescript-ui-listview"
    xmlns:df="nativescript-ui-dataform"
    xmlns:customUI="~/04 Custom UI">
    <GridLayout class="gradientBg" rows="auto,auto,*,auto">
        <GridLayout class="topBar" row="0" columns="40,*">
            <Image col="0" src="~/06 Assets/00 General/back_arrow.png" height="20" tap="goBack" />
            <Label col="1" class="h1" text="Profile" tap="goBack" />
        </GridLayout>

        <GridLayout class="lobangInfoContainer" row="1" height="30%">
            <GridLayout style="{{lobang.getBackgroundImageCss()}}"></GridLayout>
            <GridLayout rows="*,*,*,*,*,*" columns="auto,5,*" style="padding:10%">
                <Label row="0" col="0" colSpan="2" style="font-size: 17%; font-weight: bold" text="{{lobang.lobang_name}}" textWrap="true" />
                <StackLayout row="0" col="3" visibility="{{ lobang_host.user_id === user.user_id ? 'collapsed' : 'visible' }}">
                    <Button visibility="{{ hasJoined === 'false' ? 'visible' : 'collapsed'}}" class="-primary" text="Join" tap="joinLobangOnTap" />
                    <Button visibility="{{ hasJoined === 'true' ? 'visible' : 'collapsed'}}" class="-primary" text="Leave" tap="unjoinLobangOnTap" />
                </StackLayout>
                <Label row="1" col="0" colSpan="3" text="{{lobang.joined.length + ' people joined'}}" />
                <Label row="2" col="2" style="font-weight: bold" text="{{lobang.products.length + ' products'}}" />
                <Label row="3" col="2" style="font-weight: bold" text="{{lobang.getTimeLeft()}}" />
                <Label row="4" col="2" style="font-weight: bold" text="{{lobang.getTags()}}" textWrap="true" />
                <Image row="2" col="0" src="~/06 Assets/10 Lobang Icons/products.png" height="30" />
                <Image row="3" col="0" src="~/06 Assets/10 Lobang Icons/time-left.png" height="30" />
                <Image row="4" col="0" src="~/06 Assets/10 Lobang Icons/tag.png" height="30" />
            </GridLayout>
        </GridLayout>

        <GridLayout class="lobangTabContainer" row="2" rows="60%, *" columns="5,*,5,*,5,*,5">
            <GridLayout row="0" col="1" class="{{tab == 'lobangDetails' ? 'tabHeaderSelected' : 'tabHeaderUnselected'}}" tap="toggleDetailsTab">
                <Image src="~/06 Assets/10 Lobang Icons/Details.png" height="75" />
            </GridLayout>
            <GridLayout row="0" col="3" class="{{tab == 'lobangAnnouncements' ? 'tabHeaderSelected' : 'tabHeaderUnselected'}}" tap="toggleAnnouncementsTab">
                <Image src="~/06 Assets/10 Lobang Icons/Announcements.png" height="75" />
            </GridLayout>
            <GridLayout row="0" col="5" class="{{tab == 'lobangOrders' ? 'tabHeaderSelected' : 'tabHeaderUnselected'}}" tap="toggleOrdersTab">
                <Image src="~/06 Assets/10 Lobang Icons/Product.png" height="75" />
            </GridLayout>

            <ScrollView hidden="{{tab!='lobangDetails'}}" row="1" colSpan="7" orientation="vertical" scrollBarIndicatorVisible="false">
                <StackLayout>
                    <GridLayout class="hostInfoContainer" columns="*,*,*" height="22%">
                        <Label col="0" style="font-size: 17%; font-weight: bold" text="Hosted by" />
                        <StackLayout col="1" height="100%">
                            <GridLayout class="profilePicContainer">
                                <Image class="profilePic" src="{{lobang_host.profile_pic_uri}}" stretch="aspectFill"></Image>
                            </GridLayout>
                        </StackLayout>
                        <StackLayout col="2">
                            <Label style="font-size: 15%" text="{{lobang_host.first_name + ' ' + lobang_host.last_name}}" />
                            <Label style="font-size: 15%" text="{{'@' + lobang_host.user_id}}" />
                            <Label style="font-size: 15%" text="{{lobang_host.date_joined | displayDateJoined }}" />
                            <Label style="font-size: 15%" text="{{lobang_host.getRating() + '/5 Rating'}}" />

                            <GridLayout columns="auto, auto" height="15%">
                                <Image col="0" height="12" src="{{lobang_host.verified | getVerifiedIcon}}" />
                                <Label col="1" text="{{' ' + lobang_host.getVerifiedStatusString().split(' ')[0]}}" />
                            </GridLayout>
                        </StackLayout>
                    </GridLayout>

                    <GridLayout class="collectionPointContainer" columns="*,*,*,*,*" height="22%">
                        <Label style="font-size: 17%; font-weight: bold" col="0" colSpan="3" text="Collection Point" />
                        <Label style="font-size: 15%" col="3" colSpan="2" text="{{lobang.location[0] + lobang.location.toLowerCase().substring(1)}}" />
                    </GridLayout>

                    <GridLayout class="collectionDatetimeContainer" columns="*,*,*,*,*" height="22%">
                        <Label style="font-size: 17%; font-weight: bold" col="0" colSpan="3" text="Collection Date, Time" />
                        <Label style="font-size: 15%" col="3" colSpan="2" text="{{lobang.collection_date}}" textWrap="true" />
                    </GridLayout>

                    <GridLayout class="descriptionContainer" columns="*,*,*,*,*" height="22%">
                        <Label style="font-size: 17%; font-weight: bold" col="0" colSpan="3" text="Description" />
                        <Label style="font-size: 15%" col="3" colSpan="2" text="{{lobang.description}}" textWrap="true" />
                    </GridLayout>
                    <Button visibility="{{ lobang_host.user_id === user.user_id ? 'visible' : 'collapsed' }}" class="-primary" text="Edit Lobang" tap="editLobangOnTap" />
                </StackLayout>
            </ScrollView>

            <ScrollView hidden="{{tab!='editLobang'}}" row="1" colSpan="7" orientation="vertical" scrollBarIndicatorVisible="false">
                <StackLayout style="padding:10%">
                    <Label class="h1" text="Edit Lobang" />
                    <StackLayout>
                        <Label row="0" col="0" style="font-size:20%; margin-left:5" text="{{temp_lobang.lobang_name}}" textWrap="true" />
                        <df:RadDataForm row="1" id="tempLobangDataForm" source="{{temp_lobang}}">
                            <df:RadDataForm.properties>
                                <df:EntityProperty name="location" displayName="Collection point" valuesProvider="Ang Mo Kio, Bedok, Bishan, Bukit Batok, Bukit Merah, Bukit Panjang, Bukit Timah, Central Area, Choa Chu Kang, Clementi, Geylang, Hougang, Jurong East, Jurong West, Kallang/Whampoa, Marine Parade, Pasir Ris, Punggol, Queenstown, Sembawang, Sengkang, Serangoon, Tampines, Tengah, Toa Payoh, Woodlands, Yishun">
                                    <df:EntityProperty.editor>
                                        <df:PropertyEditor type="Picker" />
                                    </df:EntityProperty.editor>
                                </df:EntityProperty>
                                <df:EntityProperty name="collection_date" displayName="Collection date">
                                    <df:EntityProperty.editor>
                                        <df:PropertyEditor type="DatePicker" />
                                    </df:EntityProperty.editor>
                                </df:EntityProperty>
                                <df:EntityProperty name="last_order_date" displayName="Last order date">
                                    <df:EntityProperty.editor>
                                        <df:PropertyEditor type="DatePicker" />
                                    </df:EntityProperty.editor>
                                </df:EntityProperty>
                                <df:EntityProperty name="_observers" hidden="true" />
                                <df:EntityProperty name="_map" hidden="true" />
                                <df:EntityProperty name="lobang_id" hidden="true" />
                                <df:EntityProperty name="lobang_name" hidden="true" />
                                <df:EntityProperty name="createdBy" hidden="true" />
                                <df:EntityProperty name="categories" hidden="true" />
                                <df:EntityProperty name="tags" hidden="true" />
                                <df:EntityProperty name="products" hidden="true" />
                                <df:EntityProperty name="coins" hidden="true" />
                                <df:EntityProperty name="joined" hidden="true" />
                                <df:EntityProperty name="lobang_status" hidden="true" />
                                <df:EntityProperty name="announcements" hidden="true" />
                            </df:RadDataForm.properties>
                        </df:RadDataForm>
                        <Button class="-primary" text="Submit" tap="updateLobangOnTap" />
                        <Button class="-primary" text="Cancel" tap="toggleDetailsTab" />
                    </StackLayout>
                </StackLayout>
            </ScrollView>

            <ScrollView hidden="{{tab!='lobangAnnouncements'}}" row="1" colSpan="7" orientation="vertical" scrollBarIndicatorVisible="false">
                <StackLayout style="padding:10%">
                    <Repeater items="{{announcements}}">
                        <Repeater.itemsLayout>
                            <StackLayout orientation="vertical" />
                        </Repeater.itemsLayout>
                        <Repeater.itemTemplate>
                            <GridLayout class="announcementPanel">
                                <GridLayout rows="50,auto,*" columns="200, auto, auto, auto" style="padding:10%">
                                    <Label class="fineprint" row="0" col="0" text="{{lobang_name}}" />
                                    <Label class="fineprint" row="0" col="2" text="{{datetime}}" />
                                    <Button row="1" col="2" text="Edit" class='-primary -rounded-sm' width="60dip" tap='editAnnouncementDialog' />
                                    <Label class="fineprint" row="1" col="0" colSpan="3" text="{{description}}" textWrap="true" />
                                    <GridLayout class="announcementPicContainer" row="2" col="0" colSpan="4" hidden="{{ picture === null }}">
                                        <Image class="announcementPic" src="{{picture}}" stretch="aspectFill" />
                                    </GridLayout>
                                </GridLayout>
                            </GridLayout>
                        </Repeater.itemTemplate>
                    </Repeater>
                    <Button visibility="{{ lobang_host.user_id === user.user_id ? 'visible' : 'collapsed' }}" text="Create Announcement" class='-primary -rounded-sm' tap='createAnnouncementDialog' />
                </StackLayout>
            </ScrollView>

            <ScrollView hidden="{{tab!='lobangOrders'}}" row="1" colSpan="7" orientation="vertical" scrollBarIndicatorVisible="false">
                <StackLayout style="padding:10%">
                    <GridLayout visibility="{{ lobang_host.user_id !== user.user_id ? 'visible' : 'collapsed' }}">
                        <StackLayout visibility="{{ hasOrder ? 'collapsed' : 'visible' }}" style="padding:10%">
                            <Label style="font-size: 17%; font-weight: bold" text="{{ 'Products (' + temp_prodArr.length + ')' }}" />
                            <StackLayout style="padding:10%">
                                <Repeater items="{{temp_prodArr}}">
                                    <Repeater.itemsLayout>
                                        <StackLayout orientation="vertical" />
                                    </Repeater.itemsLayout>
                                    <Repeater.itemTemplate>
                                        <StackLayout>
                                            <GridLayout rows="auto,auto" style="padding:10%" class="productPanel">
                                                <GridLayout row="0" rows="*,*" columns="3,auto,auto">
                                                    <Label class="h2-large" row="0" colSpan="2" text="{{product_name}}" />
                                                    <Label class="fineprint" row="0" col="2" text="{{ '$' + price}}" />
                                                </GridLayout>
                                                <TextField row="1" col="1" text="{{qty_ordered}}" />
                                            </GridLayout>
                                        </StackLayout>
                                    </Repeater.itemTemplate>
                                </Repeater>
                                <Button text="Submit Order" class='-primary -rounded-sm' tap='submitOrderOnTap' />
                            </StackLayout>
                        </StackLayout>
                        <StackLayout visibility="{{ hasOrder ? 'visible' : 'collapsed' }}" style="padding:10%">
                            <Label style="font-size: 17%; font-weight: bold" text="View Order Summary" />
                            <StackLayout class="orderContainer">
                                <Label style="font-size: 15%; font-weight: bold" text="{{user.user_id}}" />
                                <GridLayout rows="*" columns="200,auto" style="padding:10%">
                                    <Label style="font-size: 12%; font-weight: bold" row="0" col="0" text="Product Name" />
                                    <Label style="font-size: 12%; font-weight: bold" row="0" col="1" text="Quantity ordered" />
                                </GridLayout>
                                <Repeater items="{{userOrder.line_items}}">
                                    <Repeater.itemsLayout>
                                        <StackLayout orientation="vertical" />
                                    </Repeater.itemsLayout>
                                    <Repeater.itemTemplate>
                                        <StackLayout>
                                            <GridLayout rows="*" columns="200,auto" style="padding:10%">
                                                <Label class="fineprint" row="0" col="0" text="{{ product_name }}" />
                                                <Label class="fineprint" row="0" col="1" text="{{ qty_ordered }}" />
                                            </GridLayout>
                                        </StackLayout>
                                    </Repeater.itemTemplate>
                                </Repeater>
                                <GridLayout rows="*,*" columns="200,auto" style="padding:10%">
                                    <Label style="font-size: 12%; font-weight: bold" row="0" col="0" text="Total Price" />
                                    <Label style="font-size: 12%; font-weight: bold" row="0" col="1" text="{{userOrder.total_price}}" />
                                    <Label style="font-size: 12%; font-weight: bold" row="1" col="0" text="{{'Status: ' + userOrder.status}}" />
                                </GridLayout>
                            </StackLayout>
                        </StackLayout>
                    </GridLayout>
                    <GridLayout visibility="{{ lobang_host.user_id === user.user_id ? 'visible' : 'collapsed' }}">
                        <StackLayout style="padding:10%">
                            <Label style="font-size: 17%; font-weight: bold" text="{{ 'Orders (' + orders.length + ')' }}" />
                            <Repeater items="{{orders}}">
                                <Repeater.itemsLayout>
                                    <StackLayout orientation="vertical" />
                                </Repeater.itemsLayout>
                                <Repeater.itemTemplate>
                                    <StackLayout class="orderContainer">
                                        <Label style="font-size: 15%; font-weight: bold" text="{{user_id}}" />
                                        <GridLayout rows="*" columns="200,auto" style="padding:10%">
                                            <Label style="font-size: 12%; font-weight: bold" row="0" col="0" text="Product Name" />
                                            <Label style="font-size: 12%; font-weight: bold" row="0" col="1" text="Quantity ordered" />
                                        </GridLayout>
                                        <Repeater items="{{line_items}}">
                                            <Repeater.itemsLayout>
                                                <StackLayout orientation="vertical" />
                                            </Repeater.itemsLayout>
                                            <Repeater.itemTemplate>
                                                <StackLayout>
                                                    <GridLayout rows="*" columns="200,auto" style="padding:10%">
                                                        <Label class="fineprint" row="0" col="0" text="{{ product_name }}" />
                                                        <Label class="fineprint" row="0" col="1" text="{{ qty_ordered }}" />
                                                    </GridLayout>
                                                </StackLayout>
                                            </Repeater.itemTemplate>
                                        </Repeater>
                                        <GridLayout rows="*,*" columns="200,auto" style="padding:10%">
                                            <Label style="font-size: 12%; font-weight: bold" row="0" col="0" text="Total Price" />
                                            <Label style="font-size: 12%; font-weight: bold" row="0" col="1" text="{{total_price}}" />
                                            <Label style="font-size: 12%; font-weight: bold" row="1" col="0" text="{{'Status: ' + status }}" />
                                            <Button row="1" col="1" text="Update Status" class='-primary -rounded-sm' tap='updateOrderStatusDialog' />
                                        </GridLayout>
                                    </StackLayout>
                                </Repeater.itemTemplate>
                            </Repeater>
                        </StackLayout>
                    </GridLayout>
                </StackLayout>
            </ScrollView>
        </GridLayout>
        <customUI:navbar row="3" />
    </GridLayout>
</Page>